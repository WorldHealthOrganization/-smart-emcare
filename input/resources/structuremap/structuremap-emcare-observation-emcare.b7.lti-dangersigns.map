map 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureMap/emcare-observation-emcare.b7.lti-dangersigns' = 'emcare-observation-emcare.b7.lti-dangersigns'

// emcareb7ltidangersigns:https://fhir.dk.swisstph-mis.ch/matchbox/fhir/Questionnaire/emcare.b7.lti-dangersigns
uses 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaireresponse' alias 'questionnaireResponse' as source
// Bundle are require where there is multiple ressource to be mapped
uses 'http://hl7.org/fhir/StructureDefinition/Bundle' alias 'bundle' as target
// target that will be inserted in the bundle
uses 'http://hl7.org/fhir/StructureDefinition/Observation' alias 'Observation' as target

group bundleMapping(source src : questionnaireResponse, target bundle : Bundle) {
    src -> bundle.id = uuid() 'id';
    src -> bundle.type = 'batch' 'type';
     src -> uuid() as emcareb7de01id,uuid() as emcareb7de02id,uuid() as emcareb7de03id,uuid() as emcareb7de08id,uuid() as emcareb7de09id,uuid() as emcareb8b9de01id,uuid() as emcareb8b9de02id,uuid() as emcareb8b9de03id then {
        src -> 
            bundle.entry as entry,
            entry.fullUrl = append("urn:uuid:",emcareb7de01id), 
            entry.request as request, 
            request.method = "PUT", 
            request.url = append("None/", emcareb7de01id),
            entry.resource = create('Observation') as tgt then {src.item first as item  where linkId =  'emcareb7de01' -> item.answer as a then SetObservationemcareb7de01(src, a, tgt , emcareb7de01id) 'obs-rule';}  'emcareb7de01grouprule';
            
        src -> 
            bundle.entry as entry,
            entry.fullUrl = append("urn:uuid:",emcareb7de02id), 
            entry.request as request, 
            request.method = "PUT", 
            request.url = append("None/", emcareb7de02id),
            entry.resource = create('Observation') as tgt then {src.item first as item  where linkId =  'emcareb7de02' -> item.answer as a then SetObservationemcareb7de02(src, a, tgt , emcareb7de02id) 'obs-rule';}  'emcareb7de02grouprule';
            
        src -> 
            bundle.entry as entry,
            entry.fullUrl = append("urn:uuid:",emcareb7de03id), 
            entry.request as request, 
            request.method = "PUT", 
            request.url = append("None/", emcareb7de03id),
            entry.resource = create('Observation') as tgt then {src.item first as item  where linkId =  'emcareb7de03' -> item.answer as a then SetObservationemcareb7de03(src, a, tgt , emcareb7de03id) 'obs-rule';}  'emcareb7de03grouprule';
            
        src -> 
            bundle.entry as entry,
            entry.fullUrl = append("urn:uuid:",emcareb7de08id), 
            entry.request as request, 
            request.method = "PUT", 
            request.url = append("None/", emcareb7de08id),
            entry.resource = create('Observation') as tgt then {src.item first as item  where linkId =  'emcareb7de08' -> item.answer as a then SetObservationemcareb7de08(src, a, tgt , emcareb7de08id) 'obs-rule';}  'emcareb7de08grouprule';
            
        src -> 
            bundle.entry as entry,
            entry.fullUrl = append("urn:uuid:",emcareb7de09id), 
            entry.request as request, 
            request.method = "PUT", 
            request.url = append("None/", emcareb7de09id),
            entry.resource = create('Observation') as tgt then {src.item first as item  where linkId =  'emcareb7de09' -> item.answer as a then SetObservationemcareb7de09(src, a, tgt , emcareb7de09id) 'obs-rule';}  'emcareb7de09grouprule';
            
        src -> 
            bundle.entry as entry,
            entry.fullUrl = append("urn:uuid:",emcareb8b9de01id), 
            entry.request as request, 
            request.method = "PUT", 
            request.url = append("None/", emcareb8b9de01id),
            entry.resource = create('Observation') as tgt then {src.item first as item  where linkId =  'emcareb8b9de01' -> item.answer as a then SetObservationemcareb8b9de01(src, a, tgt , emcareb8b9de01id) 'obs-rule';}  'emcareb8b9de01grouprule';
            
        src -> 
            bundle.entry as entry,
            entry.fullUrl = append("urn:uuid:",emcareb8b9de02id), 
            entry.request as request, 
            request.method = "PUT", 
            request.url = append("None/", emcareb8b9de02id),
            entry.resource = create('Observation') as tgt then {src.item first as item  where linkId =  'emcareb8b9de02' -> item.answer as a then SetObservationemcareb8b9de02(src, a, tgt , emcareb8b9de02id) 'obs-rule';}  'emcareb8b9de02grouprule';
            
        src -> 
            bundle.entry as entry,
            entry.fullUrl = append("urn:uuid:",emcareb8b9de03id), 
            entry.request as request, 
            request.method = "PUT", 
            request.url = append("None/", emcareb8b9de03id),
            entry.resource = create('Observation') as tgt then {src.item first as item  where linkId =  'emcareb8b9de03' -> item.answer as a then SetObservationemcareb8b9de03(src, a, tgt , emcareb8b9de03id) 'obs-rule';}  'emcareb8b9de03grouprule';
            	}'gen-ids';
}


group SetObservationemcareb7de01(source src, source a, target tgt, source oid ){
    oid ->  tgt.id = oid,
            tgt.identifier = create('Identifier') as CodeID, 
            CodeID.system = 'http://hl7.org/fhir/namingsystem-identifier-type',
            CodeID.use =  'official',
            CodeID.value = 'uuid',
            CodeID.id = oid
            'set-id';

    src -> tgt.basedOn = src.basedOn,
        tgt.encounter = src.encounter,
        tgt. subject = src. subject,
        tgt.meta = create('Meta') as newMeta, newMeta.profile = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureDefinition/emcareb7de01',
        
        tgt.code = create('CodeableConcept') as concept, 
            concept.system = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/CodeSystem/emcare-custom-codes',
            concept.code = 'EmCare.B7.DE01' 'set-code';
    src.item as item where linkId  = 'timestamp', item.answer as a -> tgt.issued = a 'EmCare.A.DE08-main';       
    
    a  where a.value = true -> tgt.status = 'final' 'set-final';
    a  where a.value = false -> tgt.status = 'cancelled' 'set-nofound'; 
    
}
    


group SetObservationemcareb7de02(source src, source a, target tgt, source oid ){
    oid ->  tgt.id = oid,
            tgt.identifier = create('Identifier') as CodeID, 
            CodeID.system = 'http://hl7.org/fhir/namingsystem-identifier-type',
            CodeID.use =  'official',
            CodeID.value = 'uuid',
            CodeID.id = oid
            'set-id';

    src -> tgt.basedOn = src.basedOn,
        tgt.encounter = src.encounter,
        tgt. subject = src. subject,
        tgt.meta = create('Meta') as newMeta, newMeta.profile = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureDefinition/emcareb7de02',
        
        tgt.code = create('CodeableConcept') as concept, 
            concept.system = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/CodeSystem/emcare-custom-codes',
            concept.code = 'EmCare.B7.DE02' 'set-code';
    src.item as item where linkId  = 'timestamp', item.answer as a -> tgt.issued = a 'EmCare.A.DE08-main';       
    
    a  where a.value = true -> tgt.status = 'final' 'set-final';
    a  where a.value = false -> tgt.status = 'cancelled' 'set-nofound'; 
    
}
    


group SetObservationemcareb7de03(source src, source a, target tgt, source oid ){
    oid ->  tgt.id = oid,
            tgt.identifier = create('Identifier') as CodeID, 
            CodeID.system = 'http://hl7.org/fhir/namingsystem-identifier-type',
            CodeID.use =  'official',
            CodeID.value = 'uuid',
            CodeID.id = oid
            'set-id';

    src -> tgt.basedOn = src.basedOn,
        tgt.encounter = src.encounter,
        tgt. subject = src. subject,
        tgt.meta = create('Meta') as newMeta, newMeta.profile = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureDefinition/emcareb7de03',
        
        tgt.code = create('CodeableConcept') as concept, 
            concept.system = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/CodeSystem/emcare-custom-codes',
            concept.code = 'EmCare.B7.DE03' 'set-code';
    src.item as item where linkId  = 'timestamp', item.answer as a -> tgt.issued = a 'EmCare.A.DE08-main';       
    
    a  where a.value = true -> tgt.status = 'final' 'set-final';
    a  where a.value = false -> tgt.status = 'cancelled' 'set-nofound'; 
    
}
    


group SetObservationemcareb7de08(source src, source a, target tgt, source oid ){
    oid ->  tgt.id = oid,
            tgt.identifier = create('Identifier') as CodeID, 
            CodeID.system = 'http://hl7.org/fhir/namingsystem-identifier-type',
            CodeID.use =  'official',
            CodeID.value = 'uuid',
            CodeID.id = oid
            'set-id';

    src -> tgt.basedOn = src.basedOn,
        tgt.encounter = src.encounter,
        tgt. subject = src. subject,
        tgt.meta = create('Meta') as newMeta, newMeta.profile = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureDefinition/emcareb7de08',
        
        tgt.code = create('CodeableConcept') as concept, 
            concept.system = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/CodeSystem/emcare-custom-codes',
            concept.code = 'EmCare.B7.DE08' 'set-code';
    src.item as item where linkId  = 'timestamp', item.answer as a -> tgt.issued = a 'EmCare.A.DE08-main';       
    
    a  where a.value = true -> tgt.status = 'final' 'set-final';
    a  where a.value = false -> tgt.status = 'cancelled' 'set-nofound'; 
    
}
    


group SetObservationemcareb7de09(source src, source a, target tgt, source oid ){
    oid ->  tgt.id = oid,
            tgt.identifier = create('Identifier') as CodeID, 
            CodeID.system = 'http://hl7.org/fhir/namingsystem-identifier-type',
            CodeID.use =  'official',
            CodeID.value = 'uuid',
            CodeID.id = oid
            'set-id';

    src -> tgt.basedOn = src.basedOn,
        tgt.encounter = src.encounter,
        tgt. subject = src. subject,
        tgt.meta = create('Meta') as newMeta, newMeta.profile = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureDefinition/emcareb7de09',
        
        tgt.code = create('CodeableConcept') as concept, 
            concept.system = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/CodeSystem/emcare-custom-codes',
            concept.code = 'EmCare.B7.DE09' 'set-code';
    src.item as item where linkId  = 'timestamp', item.answer as a -> tgt.issued = a 'EmCare.A.DE08-main';       
    
    a  where a.value = true -> tgt.status = 'final' 'set-final';
    a  where a.value = false -> tgt.status = 'cancelled' 'set-nofound'; 
    
}
    


group SetObservationemcareb8b9de01(source src, source a, target tgt, source oid ){
    oid ->  tgt.id = oid,
            tgt.identifier = create('Identifier') as CodeID, 
            CodeID.system = 'http://hl7.org/fhir/namingsystem-identifier-type',
            CodeID.use =  'official',
            CodeID.value = 'uuid',
            CodeID.id = oid
            'set-id';

    src -> tgt.basedOn = src.basedOn,
        tgt.encounter = src.encounter,
        tgt. subject = src. subject,
        tgt.meta = create('Meta') as newMeta, newMeta.profile = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureDefinition/emcareb8b9de01',
        
        tgt.code = create('CodeableConcept') as concept, 
            concept.system = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/CodeSystem/emcare-custom-codes',
            concept.code = 'EmCare.B8/B9.DE01' 'set-code';
    src.item as item where linkId  = 'timestamp', item.answer as a -> tgt.issued = a 'EmCare.A.DE08-main';       
    
    a  where a.value = true -> tgt.status = 'final' 'set-final';
    a  where a.value = false -> tgt.status = 'cancelled' 'set-nofound'; 
    
}
    


group SetObservationemcareb8b9de02(source src, source a, target tgt, source oid ){
    oid ->  tgt.id = oid,
            tgt.identifier = create('Identifier') as CodeID, 
            CodeID.system = 'http://hl7.org/fhir/namingsystem-identifier-type',
            CodeID.use =  'official',
            CodeID.value = 'uuid',
            CodeID.id = oid
            'set-id';

    src -> tgt.basedOn = src.basedOn,
        tgt.encounter = src.encounter,
        tgt. subject = src. subject,
        tgt.meta = create('Meta') as newMeta, newMeta.profile = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureDefinition/emcareb8b9de02',
        
        tgt.code = create('CodeableConcept') as concept, 
            concept.system = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/CodeSystem/emcare-custom-codes',
            concept.code = 'EmCare.B8/B9.DE02' 'set-code';
    src.item as item where linkId  = 'timestamp', item.answer as a -> tgt.issued = a 'EmCare.A.DE08-main';       
    
    a  where a.value = true -> tgt.status = 'final' 'set-final';
    a  where a.value = false -> tgt.status = 'cancelled' 'set-nofound'; 
    
}
    


group SetObservationemcareb8b9de03(source src, source a, target tgt, source oid ){
    oid ->  tgt.id = oid,
            tgt.identifier = create('Identifier') as CodeID, 
            CodeID.system = 'http://hl7.org/fhir/namingsystem-identifier-type',
            CodeID.use =  'official',
            CodeID.value = 'uuid',
            CodeID.id = oid
            'set-id';

    src -> tgt.basedOn = src.basedOn,
        tgt.encounter = src.encounter,
        tgt. subject = src. subject,
        tgt.meta = create('Meta') as newMeta, newMeta.profile = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/StructureDefinition/emcareb8b9de03',
        
        tgt.code = create('CodeableConcept') as concept, 
            concept.system = 'https://fhir.dk.swisstph-mis.ch/matchbox/fhir/CodeSystem/emcare-custom-codes',
            concept.code = 'EmCare.B8/B9.DE03' 'set-code';
    src.item as item where linkId  = 'timestamp', item.answer as a -> tgt.issued = a 'EmCare.A.DE08-main';       
    
    a  where a.value = true -> tgt.status = 'final' 'set-final';
    a  where a.value = false -> tgt.status = 'cancelled' 'set-nofound'; 
    
}
    

